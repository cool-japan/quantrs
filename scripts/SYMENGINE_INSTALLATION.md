# SymEngine Installation Guide for quantrs2-symengine-sys

This document provides comprehensive instructions for installing SymEngine and resolving build issues with the `quantrs2-symengine-sys` crate.

## Problem Description

When building `quantrs2-symengine-sys`, you may encounter this error:

```
error: failed to run custom build command for `quantrs2-symengine-sys v0.1.0`

--- stderr
wrapper.h:1:10: fatal error: 'symengine/cwrapper.h' file not found

thread 'main' panicked at quantrs2-symengine-sys/build.rs:288:39:
Unable to generate bindings: ClangDiagnostic("wrapper.h:1:10: fatal error: 'symengine/cwrapper.h' file not found\n")
```

This occurs because SymEngine headers are not installed on the system.

## Solution Overview

The repository provides automated installation scripts that:

1. Install all required system dependencies (GMP, MPFR, build tools)
2. Build SymEngine from source with optimal configuration
3. Install SymEngine to a local directory (`/tmp/symengine_install`)
4. Configure environment variables for the Rust build system
5. Verify the installation by testing the build

## Available Scripts

### 1. `symengine_install_sample.sh`

The main installation script that completely sets up SymEngine.

**Features:**
- Installs system dependencies (libgmp-dev, libmpfr-dev, cmake, ninja-build)
- Clones SymEngine from the official repository
- Builds with Release configuration, shared libraries, GMP, MPFR, and OpenMP support
- Installs to `/tmp/symengine_install`
- Creates environment configuration script
- Tests the build to ensure everything works

**Usage:**
```bash
bash ./scripts/symengine_install_sample.sh
```

### 2. `symengine_env_sample.sh`

Environment configuration script (auto-generated by the installation script).

**Features:**
- Sets `SYMENGINE_DIR`, `GMP_DIR`, `MPFR_DIR`
- Configures `LD_LIBRARY_PATH` for runtime linking
- Sets `BINDGEN_EXTRA_CLANG_ARGS` for header discovery

**Usage:**
```bash
source ./scripts/symengine_env_sample.sh
```

## Installation Steps

### Step 1: Run the Installation Script

```bash
# Make the script executable (if needed)
chmod +x ./scripts/symengine_install_sample.sh

# Run the installation
bash ./scripts/symengine_install_sample.sh
```

The script will:
- Check and install required dependencies
- Download and build SymEngine
- Install to `/tmp/symengine_install`
- Create `/tmp/symengine_env.sh` with environment variables
- Test the build automatically

### Step 2: Configure Your Environment

For subsequent builds, you need to set up the environment:

```bash
# Source the environment variables
source /tmp/symengine_env.sh

# Or copy and use the sample from scripts directory
cp ./scripts/symengine_env_sample.sh /tmp/symengine_env.sh
source /tmp/symengine_env.sh
```

### Step 3: Build quantrs2-symengine-sys

```bash
# With environment configured, build the crate
cargo build --package quantrs2-symengine-sys

# Or build the entire project
cargo build
```

## Environment Variables Reference

The following environment variables are configured by the installation:

| Variable | Value | Purpose |
|----------|-------|---------|
| `SYMENGINE_DIR` | `/tmp/symengine_install` | SymEngine installation directory |
| `GMP_DIR` | `/usr` | GMP library location |
| `MPFR_DIR` | `/usr` | MPFR library location |
| `LD_LIBRARY_PATH` | Includes SymEngine libs | Runtime library discovery |
| `BINDGEN_EXTRA_CLANG_ARGS` | Header include paths | Compile-time header discovery |

## Manual Installation (Alternative)

If you prefer manual installation, follow these steps:

### 1. Install Dependencies

```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install -y build-essential cmake ninja-build \
  libgmp-dev libmpfr-dev git

# For bindgen (if not already available)
sudo apt-get install -y clang-14 libclang-14-dev
```

### 2. Build SymEngine

```bash
# Clone SymEngine
git clone --depth=1 https://github.com/symengine/symengine.git /tmp/symengine
cd /tmp/symengine

# Configure
cmake -S . -B build -G Ninja \
  -DCMAKE_BUILD_TYPE=Release \
  -DBUILD_SHARED_LIBS=ON \
  -DWITH_GMP=ON \
  -DWITH_MPFR=ON \
  -DWITH_OPENMP=ON \
  -DCMAKE_INSTALL_PREFIX=/tmp/symengine_install

# Build and install
ninja -C build
ninja -C build install
```

### 3. Configure Environment

```bash
export SYMENGINE_DIR=/tmp/symengine_install
export GMP_DIR=/usr
export MPFR_DIR=/usr
export LD_LIBRARY_PATH=/tmp/symengine_install/lib:/usr/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH
export BINDGEN_EXTRA_CLANG_ARGS="-I/tmp/symengine_install/include -I/usr/include"
```

## Troubleshooting

### Common Issues

1. **Missing GMP/MPFR libraries**
   ```
   Could NOT find MPFR (missing: MPFR_LIBRARIES MPFR_INCLUDE_DIRS)
   ```
   **Solution:** Install development packages: `sudo apt-get install libgmp-dev libmpfr-dev`

2. **Clang/bindgen issues**
   ```
   Unable to find libclang
   ```
   **Solution:** Install clang development packages: `sudo apt-get install clang-14 libclang-14-dev`

3. **Permission errors**
   **Solution:** The script installs to `/tmp` which should be writable. If using a different location, ensure write permissions.

4. **Build cache issues**
   **Solution:** Clean the build cache: `cargo clean` before rebuilding.

### Verification

To verify your installation:

```bash
# Check SymEngine headers
test -f /tmp/symengine_install/include/symengine/cwrapper.h && echo "Headers OK"

# Check SymEngine library
test -f /tmp/symengine_install/lib/libsymengine.so && echo "Library OK"

# Test the build
source /tmp/symengine_env.sh
cargo build --package quantrs2-symengine-sys
```

## Production Deployment

For production environments, consider:

1. **System-wide installation:** Install SymEngine to `/usr/local` instead of `/tmp`
2. **Package management:** Use system package managers when SymEngine packages are available
3. **Docker:** Include SymEngine installation in your container image
4. **CI/CD:** Cache the built SymEngine installation across builds

## Notes

- The installation uses `/tmp` which may be cleared on system restart
- The scripts are designed for Ubuntu/Debian systems but can be adapted for other distributions
- SymEngine is built with Release configuration for optimal performance
- The installation includes GMP and MPFR support for arbitrary precision arithmetic
- OpenMP support is enabled for parallel computations

## Related Documentation

- [SymEngine Official Documentation](https://github.com/symengine/symengine)
- [Project Linux Build Guide](../docs/LINUX_BUILD_GUIDE.md)
- [Project macOS Build Guide](../docs/MACOS_BUILD_GUIDE.md)

For additional help, check the project's issue tracker or documentation.